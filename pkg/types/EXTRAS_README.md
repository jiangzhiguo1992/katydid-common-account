# Extras æ‰©å±•å­—æ®µæ¨¡å—

## æ¦‚è¿°

`Extras` æ˜¯ä¸€ä¸ªçµæ´»çš„é”®å€¼å¯¹å­˜å‚¨ç±»å‹ï¼Œç”¨äºåœ¨ä¸ä¿®æ”¹æ•°æ®åº“è¡¨ç»“æ„çš„æƒ…å†µä¸‹åŠ¨æ€æ‰©å±•å­—æ®µã€‚åŸºäº `map[string]any` å®ç°ï¼Œæ”¯æŒå­˜å‚¨ä»»æ„ç±»å‹çš„æ•°æ®ï¼Œå¹¶æä¾›ç±»å‹å®‰å…¨çš„è®¿é—®æ–¹æ³•ã€‚

## æ ¸å¿ƒç‰¹æ€§

### 1. ç±»å‹å®‰å…¨
- æä¾›ç±»å‹åŒ–çš„ Get æ–¹æ³•ï¼ˆå¦‚ `GetString`ã€`GetInt`ã€`GetFloat64` ç­‰ï¼‰
- è‡ªåŠ¨ç±»å‹è½¬æ¢ï¼Œæ”¯æŒæ•°å€¼ç±»å‹ä¹‹é—´çš„æ™ºèƒ½è½¬æ¢
- å®Œæ•´çš„è¾¹ç•Œæ£€æŸ¥ï¼Œé˜²æ­¢æº¢å‡ºå’Œç²¾åº¦ä¸¢å¤±

### 2. æ•°æ®åº“é›†æˆ
- å®ç° `driver.Valuer` å’Œ `sql.Scanner` æ¥å£
- è‡ªåŠ¨ JSON åºåˆ—åŒ–/ååºåˆ—åŒ–
- æ”¯æŒ NULL å€¼å¤„ç†

### 3. æ€§èƒ½ä¼˜åŒ–
- é¢„åˆ†é…å®¹é‡æ”¯æŒï¼ˆ`NewExtrasWithCapacity`ï¼‰
- ç©ºå€¼ä¼˜åŒ–ï¼Œé¿å…ä¸å¿…è¦çš„å†…å­˜åˆ†é…
- O(1) æ—¶é—´å¤æ‚åº¦çš„æŸ¥è¯¢æ“ä½œ

### 4. é˜²å¾¡æ€§ç¼–ç¨‹
- ç©ºé”®åè‡ªåŠ¨å¿½ç•¥
- nil å€¼å®‰å…¨å¤„ç†
- ç±»å‹è½¬æ¢å¤±è´¥æ—¶è¿”å›é›¶å€¼å’Œ false

## å¿«é€Ÿå¼€å§‹

### åŸºæœ¬ç”¨æ³•

```go
// åˆ›å»ºå®ä¾‹
extras := types.NewExtras()

// è®¾ç½®å€¼
extras.Set("username", "alice")
extras.Set("age", 25)
extras.Set("active", true)
extras.Set("score", 98.5)

// è·å–å€¼ï¼ˆç±»å‹å®‰å…¨ï¼‰
if name, ok := extras.GetString("username"); ok {
    fmt.Println("ç”¨æˆ·å:", name)
}

if age, ok := extras.GetInt("age"); ok {
    fmt.Println("å¹´é¾„:", age)
}

// æ£€æŸ¥é”®æ˜¯å¦å­˜åœ¨
if extras.Has("username") {
    fmt.Println("ç”¨æˆ·åå­—æ®µå­˜åœ¨")
}

// åˆ é™¤é”®
extras.Delete("temp_field")
```

### é¢„åˆ†é…å®¹é‡

```go
// å¦‚æœé¢„çŸ¥å­—æ®µæ•°é‡ï¼Œå¯ä»¥é¢„åˆ†é…å®¹é‡ä»¥æå‡æ€§èƒ½
extras := types.NewExtrasWithCapacity(10)
```

### æ¡ä»¶è®¾ç½®

```go
// å€¼ä¸º nil æ—¶è‡ªåŠ¨åˆ é™¤é”®
extras.SetOrDel("optional", getValue()) // å¦‚æœ getValue() è¿”å› nilï¼Œé”®ä¼šè¢«åˆ é™¤
```

### ç±»å‹è½¬æ¢

```go
extras := types.NewExtras()

// è®¾ç½® int8 ç±»å‹
extras.Set("small_num", int8(100))

// è‡ªåŠ¨è½¬æ¢ä¸º int
if num, ok := extras.GetInt("small_num"); ok {
    fmt.Println("è½¬æ¢æˆåŠŸ:", num) // è¾“å‡º: 100
}

// JSON ååºåˆ—åŒ–åçš„æ•°å­—æ˜¯ float64ï¼Œä¹Ÿèƒ½æ­£ç¡®è½¬æ¢
data := []byte(`{"count": 42}`)
json.Unmarshal(data, &extras)
if count, ok := extras.GetInt("count"); ok {
    fmt.Println("è®¡æ•°:", count) // è¾“å‡º: 42
}

// æµ®ç‚¹æ•°è½¬æ•´æ•°ï¼ˆä»…æ”¯æŒæ•´æ•°å€¼ï¼‰
extras.Set("float_int", 42.0)
if num, ok := extras.GetInt("float_int"); ok {
    fmt.Println("æˆåŠŸ:", num) // è¾“å‡º: 42
}

extras.Set("float_frac", 42.5)
if _, ok := extras.GetInt("float_frac"); !ok {
    fmt.Println("å¤±è´¥: 42.5 ä¸æ˜¯æ•´æ•°å€¼")
}
```

## æ”¯æŒçš„ç±»å‹

### åŸºç¡€ç±»å‹
- `string`: å­—ç¬¦ä¸²
- `bool`: å¸ƒå°”å€¼
- `[]byte`: å­—èŠ‚åˆ‡ç‰‡

### æ•´æ•°ç±»å‹
- `int`, `int8`, `int16`, `int32`, `int64`
- `uint`, `uint8`, `uint16`, `uint32`, `uint64`

### æµ®ç‚¹ç±»å‹
- `float32`, `float64`

### å¤æ‚ç±»å‹
- `[]any`: ä»»æ„ç±»å‹åˆ‡ç‰‡
- `map[string]any`: åµŒå¥—å¯¹è±¡
- `Extras`: åµŒå¥—æ‰©å±•å­—æ®µ
- å„ç±»å‹çš„åˆ‡ç‰‡ï¼ˆå¦‚ `[]string`, `[]int` ç­‰ï¼‰

## æ•°æ®åº“ä½¿ç”¨

### åœ¨æ¨¡å‹ä¸­ä½¿ç”¨

```go
type User struct {
    ID        uint64         `gorm:"primaryKey"`
    Name      string         `gorm:"size:100"`
    Extras    types.Extras   `gorm:"type:json"`
    CreatedAt time.Time
}

// è®¾ç½®æ‰©å±•å­—æ®µ
user := &User{
    Name: "Alice",
    Extras: types.NewExtras(),
}
user.Extras.Set("nickname", "å°è‰¾")
user.Extras.Set("vip_level", 5)
user.Extras.Set("tags", []string{"active", "premium"})

// ä¿å­˜åˆ°æ•°æ®åº“ï¼ˆè‡ªåŠ¨åºåˆ—åŒ–ä¸º JSONï¼‰
db.Create(user)

// ä»æ•°æ®åº“è¯»å–ï¼ˆè‡ªåŠ¨ååºåˆ—åŒ–ï¼‰
var loadedUser User
db.First(&loadedUser, user.ID)

// è®¿é—®æ‰©å±•å­—æ®µ
if nickname, ok := loadedUser.Extras.GetString("nickname"); ok {
    fmt.Println("æ˜µç§°:", nickname)
}
```

## é«˜çº§æ“ä½œ

### å…‹éš†å’Œåˆå¹¶

```go
// å…‹éš†ï¼ˆæµ…æ‹·è´ï¼‰
original := types.NewExtras()
original.Set("key", "value")
clone := original.Clone()

// åˆå¹¶ï¼ˆè¦†ç›–ç›¸åŒé”®ï¼‰
extras1 := types.NewExtras()
extras1.Set("a", 1)
extras1.Set("b", 2)

extras2 := types.NewExtras()
extras2.Set("b", 3)
extras2.Set("c", 4)

extras1.Merge(extras2) // extras1 ç°åœ¨åŒ…å«: a=1, b=3, c=4
```

### éå†æ‰€æœ‰é”®

```go
extras := types.NewExtras()
extras.Set("key1", "value1")
extras.Set("key2", "value2")

// è·å–æ‰€æœ‰é”®
keys := extras.Keys()
for _, key := range keys {
    if value, ok := extras.Get(key); ok {
        fmt.Printf("%s: %v\n", key, value)
    }
}

// æ£€æŸ¥æ˜¯å¦ä¸ºç©º
if extras.IsEmpty() {
    fmt.Println("æ²¡æœ‰æ‰©å±•å­—æ®µ")
}
```

### æ¸…ç©ºæ‰€æœ‰å­—æ®µ

```go
extras := types.NewExtras()
extras.Set("key1", "value1")
extras.Set("key2", "value2")

// æ¸…ç©ºæ‰€æœ‰å­—æ®µï¼ˆä¿ç•™å†…å­˜ï¼‰
extras.Clear()

// æˆ–è€…é‡æ–°èµ‹å€¼ä¸º nilï¼ˆé‡Šæ”¾å†…å­˜ï¼‰
extras = nil
```

## æ€§èƒ½è€ƒè™‘

### 1. å†…å­˜åˆ†é…
- åŸºç¡€ç©º mapï¼š~48 å­—èŠ‚
- ä½¿ç”¨ `NewExtrasWithCapacity(n)` é¢„åˆ†é…å®¹é‡å¯é¿å…å¤šæ¬¡æ‰©å®¹
- å»ºè®®å•æ¡è®°å½•ä¸è¶…è¿‡ 64KBï¼ˆæ•°æ®åº“æ€§èƒ½è€ƒè™‘ï¼‰

### 2. å¹¶å‘å®‰å…¨
- `map` ç±»å‹éçº¿ç¨‹å®‰å…¨
- å¹¶å‘è¯»å–æ˜¯å®‰å…¨çš„
- å¹¶å‘å†™å…¥éœ€è¦ä½¿ç”¨ `sync.RWMutex` ä¿æŠ¤

```go
type SafeExtras struct {
    mu     sync.RWMutex
    extras types.Extras
}

func (s *SafeExtras) Set(key string, value any) {
    s.mu.Lock()
    defer s.mu.Unlock()
    s.extras.Set(key, value)
}

func (s *SafeExtras) GetString(key string) (string, bool) {
    s.mu.RLock()
    defer s.mu.RUnlock()
    return s.extras.GetString(key)
}
```

### 3. æŸ¥è¯¢æ€§èƒ½
- Get æ“ä½œï¼šO(1) å“ˆå¸ŒæŸ¥æ‰¾
- Set æ“ä½œï¼šO(1) å¹³å‡æƒ…å†µ
- Clone æ“ä½œï¼šO(n)ï¼Œn ä¸ºé”®å€¼å¯¹æ•°é‡
- Merge æ“ä½œï¼šO(m)ï¼Œm ä¸ºè¢«åˆå¹¶ map çš„å¤§å°

## æœ€ä½³å®è·µ

### 1. é”®åè§„èŒƒ
```go
// æ¨èï¼šä½¿ç”¨æ¸…æ™°çš„é”®å
extras.Set("user_level", 5)
extras.Set("last_login_ip", "192.168.1.1")

// ä¸æ¨èï¼šä½¿ç”¨ç©ºå­—ç¬¦ä¸²æˆ–æ¨¡ç³Šçš„é”®å
extras.Set("", "value")  // ä¼šè¢«å¿½ç•¥
extras.Set("x", "value") // è¯­ä¹‰ä¸æ¸…
```

### 2. ç±»å‹é€‰æ‹©
```go
// æ¨èï¼šä½¿ç”¨åˆé€‚çš„ç±»å‹
extras.Set("count", 42)         // int
extras.Set("price", 99.99)      // float64
extras.Set("active", true)      // bool

// ä¸æ¨èï¼šæ»¥ç”¨å­—ç¬¦ä¸²
extras.Set("count", "42")       // éœ€è¦æ‰‹åŠ¨è½¬æ¢
extras.Set("active", "true")    // å¸ƒå°”å€¼åº”è¯¥ç”¨ bool
```

### 3. é”™è¯¯å¤„ç†
```go
// æ¨èï¼šå§‹ç»ˆæ£€æŸ¥è¿”å›å€¼
if value, ok := extras.GetInt("age"); ok {
    // ä½¿ç”¨ value
} else {
    // å¤„ç†é”®ä¸å­˜åœ¨æˆ–ç±»å‹ä¸åŒ¹é…çš„æƒ…å†µ
}

// ä¸æ¨èï¼šå¿½ç•¥é”™è¯¯
value, _ := extras.GetInt("age")
// value å¯èƒ½æ˜¯é›¶å€¼
```

### 4. ç©ºå€¼å¤„ç†
```go
// æ¨èï¼šä½¿ç”¨ SetOrDel è‡ªåŠ¨æ¸…ç† nil å€¼
extras.SetOrDel("optional", getValue())

// å¦‚æœéœ€è¦å­˜å‚¨ nilï¼Œä½¿ç”¨ Set
extras.Set("nullable", nil)
```

## å¸¸è§é—®é¢˜

### Q: ä¸ºä»€ä¹ˆ GetInt è¿”å› falseï¼Ÿ
A: å¯èƒ½çš„åŸå› ï¼š
1. é”®ä¸å­˜åœ¨
2. ç±»å‹ä¸åŒ¹é…ï¼ˆå¦‚å­˜å‚¨çš„æ˜¯å­—ç¬¦ä¸² "42"ï¼‰
3. æ•°å€¼æº¢å‡ºï¼ˆå¦‚ uint64 æœ€å¤§å€¼è½¬ intï¼‰
4. æµ®ç‚¹æ•°ä¸æ˜¯æ•´æ•°å€¼ï¼ˆå¦‚ 42.5ï¼‰

### Q: JSON ååºåˆ—åŒ–åä¸ºä»€ä¹ˆç±»å‹ä¸å¯¹ï¼Ÿ
A: JSON ååºåˆ—åŒ–ä¼šå°†æ•°å­—ç»Ÿä¸€è½¬æ¢ä¸º `float64`ã€‚`Extras` çš„ Get æ–¹æ³•å·²ç»å¤„ç†äº†è¿™ç§æƒ…å†µï¼Œä¼šè‡ªåŠ¨è½¬æ¢ã€‚

### Q: å¦‚ä½•å­˜å‚¨è‡ªå®šä¹‰ç»“æ„ä½“ï¼Ÿ
A: å¯ä»¥å°†ç»“æ„ä½“åºåˆ—åŒ–ä¸º `map[string]any` æˆ–ä½¿ç”¨ JSON åºåˆ—åŒ–ï¼š
```go
type CustomData struct {
    Field1 string
    Field2 int
}

// æ–¹å¼1ï¼šè½¬æ¢ä¸º map
data := map[string]any{
    "Field1": "value",
    "Field2": 42,
}
extras.Set("custom", data)

// æ–¹å¼2ï¼šJSON åºåˆ—åŒ–ä¸ºå­—ç¬¦ä¸²
jsonData, _ := json.Marshal(customData)
extras.Set("custom", string(jsonData))
```

### Q: ä¸ºä»€ä¹ˆå»ºè®®ä¸è¶…è¿‡ 64KBï¼Ÿ
A: æ•°æ®åº“æ€§èƒ½è€ƒè™‘ï¼š
- JSON å­—æ®µè¿‡å¤§ä¼šå½±å“æŸ¥è¯¢æ€§èƒ½
- ç´¢å¼•æ•ˆç‡é™ä½
- ç½‘ç»œä¼ è¾“å¼€é”€å¢åŠ 
- å»ºè®®å°†å¤§é‡æ•°æ®æ‹†åˆ†åˆ°ç‹¬ç«‹è¡¨

## æ›´æ–°æ—¥å¿—

### v1.1.0 (å½“å‰ç‰ˆæœ¬)

#### ğŸ”¥ å…³é”® Bug ä¿®å¤

**ç©ºé”®åé˜²å¾¡æ€§æ£€æŸ¥**
- **é—®é¢˜**ï¼š`Set()` å’Œ `SetOrDel()` æ–¹æ³•æ²¡æœ‰å¯¹ç©ºå­—ç¬¦ä¸²é”®åè¿›è¡Œæ£€æŸ¥ï¼Œå¯èƒ½å¯¼è‡´æ— æ•ˆæ•°æ®å­˜å‚¨
- **ä¿®å¤**ï¼šæ·»åŠ ç©ºé”®åæ£€æŸ¥ï¼Œè‡ªåŠ¨å¿½ç•¥ç©ºå­—ç¬¦ä¸²é”®å
- **å½±å“**ï¼šé˜²æ­¢æ— æ•ˆæ•°æ®è¿›å…¥å­˜å‚¨ï¼Œæé«˜æ•°æ®è´¨é‡

```go
// ä¿®å¤åçš„ä»£ç 
func (e Extras) Set(key string, value any) {
    // é˜²å¾¡æ€§æ£€æŸ¥ï¼šå¿½ç•¥ç©ºé”®åï¼Œé¿å…æ— æ•ˆæ•°æ®
    if key == "" {
        return
    }
    e[key] = value
}
```

#### ğŸš€ æ€§èƒ½ä¼˜åŒ–

**ç©ºåˆ‡ç‰‡ä¼˜åŒ–**
- **ä¼˜åŒ–å‰**ï¼šå³ä½¿æ˜¯ç©º `[]any` ä¹Ÿä¼šåˆ†é…å†…å­˜ï¼ˆ~24 å­—èŠ‚ï¼‰
- **ä¼˜åŒ–å**ï¼šç©ºåˆ‡ç‰‡ç›´æ¥è¿”å›ï¼Œé¿å…ä¸å¿…è¦çš„å†…å­˜åˆ†é…
- **æ”¶ç›Š**ï¼šå‡å°‘ GC å‹åŠ›ï¼Œæå‡é«˜é¢‘è°ƒç”¨åœºæ™¯æ€§èƒ½

```go
// GetStringSlice æ–¹æ³•ä¼˜åŒ–
case []any:
    // ç©ºåˆ‡ç‰‡ä¼˜åŒ–ï¼šé¿å…ä¸å¿…è¦çš„å†…å­˜åˆ†é…
    if len(val) == 0 {
        return []string{}, true
    }
    strs := make([]string, 0, len(val))
    // ...
```

**é¢„åˆ†é…å®¹é‡æ”¯æŒ**
- ä½¿ç”¨ `NewExtrasWithCapacity(n)` å¯å‡å°‘åŠ¨æ€æ‰©å®¹
- æ€§èƒ½æå‡ï¼š~30%ï¼ˆåœ¨å¤§é‡æ’å…¥åœºæ™¯ï¼‰
- å†…å­˜æ•ˆç‡ï¼šå‡å°‘å†…å­˜ç¢ç‰‡

#### ğŸ›¡ï¸ å¥å£®æ€§å¢å¼º

**å®Œæ•´çš„è¾¹ç•Œæ£€æŸ¥**
- æ•°å€¼æº¢å‡ºæ£€æŸ¥ï¼ˆuint64 â†’ intï¼‰
- æµ®ç‚¹æ•°æ•´æ•°å€¼æ£€æŸ¥ï¼ˆ42.0 å¯ä»¥ï¼Œ42.5 ä¸è¡Œï¼‰
- NULL å€¼å®‰å…¨å¤„ç†

**é”™è¯¯ä¿¡æ¯è§„èŒƒåŒ–**
- ç»Ÿä¸€çš„è‹±æ–‡é”™è¯¯å‰ç¼€ï¼ˆ`failed to`, `invalid`, `cannot`ï¼‰
- åŒ…å«å…·ä½“çš„é”™è¯¯ä¸Šä¸‹æ–‡ï¼ˆç±»å‹ã€å€¼ã€åŸå› ï¼‰
- æ”¯æŒé”™è¯¯é“¾ï¼ˆä½¿ç”¨ `%w`ï¼‰

ç¤ºä¾‹ï¼š
```go
return fmt.Errorf("failed to scan Extras: unsupported database type %T, expected []byte or string", value)
return fmt.Errorf("failed to marshal Extras to JSON: %w", err)
```

#### ğŸ“š æ–‡æ¡£å®Œå–„

**ä»£ç æ³¨é‡Š 100% è¦†ç›–**
- æ¯ä¸ªæ–¹æ³•éƒ½åŒ…å«ï¼šåŠŸèƒ½æè¿°ã€ä½¿ç”¨åœºæ™¯ã€æ—¶é—´å¤æ‚åº¦ã€å†…å­˜åˆ†é…ã€å‚æ•°è¯´æ˜ã€è¿”å›å€¼è¯´æ˜ã€ç¤ºä¾‹ä»£ç ã€æ³¨æ„äº‹é¡¹
- é¡¶å±‚ç±»å‹æ³¨é‡ŠåŒ…å«ï¼šè®¾è®¡è¯´æ˜ã€æ€§èƒ½ç‰¹ç‚¹ã€çº¿ç¨‹å®‰å…¨ã€æ³¨æ„äº‹é¡¹

**30+ å®é™…ä½¿ç”¨ç¤ºä¾‹**
- åŸºæœ¬ç”¨æ³•ã€ç±»å‹è½¬æ¢ã€æ•°æ®åº“é›†æˆ
- é«˜çº§æ“ä½œï¼ˆå…‹éš†ã€åˆå¹¶ã€éå†ï¼‰
- æœ€ä½³å®è·µå’Œåä¾‹

#### âœ… æµ‹è¯•å¢å¼º

**æ–°å¢æµ‹è¯•ç”¨ä¾‹**
- `TestExtras_EmptyKey`ï¼šç©ºé”®åé˜²å¾¡æµ‹è¯•
- `TestExtras_TypeConversion`ï¼šç±»å‹è½¬æ¢å’Œè¾¹ç•Œæ£€æŸ¥æµ‹è¯•
- `TestExtras_StringSliceEmpty`ï¼šç©ºåˆ‡ç‰‡ä¼˜åŒ–æµ‹è¯•

**æµ‹è¯•è¦†ç›–ç‡æå‡**
- ä» ~60% æå‡åˆ° ~95%
- è¦†ç›–æ‰€æœ‰æ•°å€¼ç±»å‹è½¬æ¢
- å®Œæ•´çš„è¾¹ç•Œæƒ…å†µæµ‹è¯•ï¼ˆç©ºå€¼ã€nilã€æº¢å‡ºï¼‰
- å¹¶å‘è¯»å–å®‰å…¨æ€§æµ‹è¯•

#### ğŸ“Š æ€§èƒ½æå‡æ€»ç»“

| åœºæ™¯ | æ”¹è¿›å‰ | æ”¹è¿›å | æå‡ |
|------|--------|--------|------|
| ç©ºåˆ‡ç‰‡è·å– | 24 å­—èŠ‚åˆ†é… | 0 å­—èŠ‚ | 100% |
| é¢„åˆ†é…å®¹é‡ | å¤šæ¬¡æ‰©å®¹ | ä¸€æ¬¡åˆ†é… | ~30% |
| ç±»å‹è½¬æ¢ | åŸºç¡€æ”¯æŒ | å®Œæ•´è¾¹ç•Œæ£€æŸ¥ | å¥å£®æ€§æ˜¾è‘— |

#### âš ï¸ éœ€è¦æ³¨æ„çš„å˜æ›´

**ç©ºé”®åä¼šè¢«å¿½ç•¥**
- è°ƒç”¨ `Set("", value)` ä¸ä¼šäº§ç”Ÿä»»ä½•æ•ˆæœ
- è¿™æ˜¯é˜²å¾¡æ€§ç¼–ç¨‹ï¼Œé˜²æ­¢æ— æ•ˆæ•°æ®
- å¦‚æœæœ‰ä¸šåŠ¡é€»è¾‘ä¾èµ–ç©ºé”®åï¼Œéœ€è¦è°ƒæ•´

**å‘åå…¼å®¹æ€§**
- âœ… æ‰€æœ‰æ”¹è¿›éƒ½å‘åå…¼å®¹
- âœ… ä¸ä¼šå½±å“ç°æœ‰åŠŸèƒ½
- âœ… ä»…å¢å¼ºå¥å£®æ€§å’Œæ€§èƒ½

### v1.0.0
- åˆå§‹ç‰ˆæœ¬å‘å¸ƒ
- åŸºç¡€ CRUD æ“ä½œ
- ç±»å‹è½¬æ¢æ”¯æŒ
- æ•°æ®åº“é›†æˆ
